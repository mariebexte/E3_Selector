<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <title>E3 Selector: Enter your data</title>

    <!-- CSS Files -->
    <link href="c3.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Aleo' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Archivo Narrow' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Arsenal' rel='stylesheet'>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- JS Files -->
    <script type="text/javascript" src="d3.min.js"></script>
    <script type="text/javascript" src="c3.min.js"></script>
    <script src="d3-simple-slider.min.js.css"></script>
    <script src="radarChart_new.js"></script>
        
    <style>
        *{
            font-family: 'Arsenal';
        }
        
        html,body
        { 
            height:100%;
        }
        
        header{
            text-align: center;
            font-size: 25pt;
            background:darkslategray;
            color:white;
        }
        
        h1{
            margin-top:10%;
            font-size: 40pt;
        }
        
        h2{
            font-size: 20pt;
        }
        
        h3{
            font-size: 18pt;
        }
    
        svg.mainElement {
            width: 100%;
            height: 100%;
            
        }
            
/*        ---- Landing Page*/
        
        .subtitle{
            margin-bottom: 5%;
        }
        
        .floatingDiv{
            float:left;
            text-align: center;
            
            margin-left: 20%;
            margin-right: 20%;
            display:table;
/*            position: relative;*/
            width:60%;
            height:20%;
        }
        
        .step{
            text-align: center;
            width:25%;
            
            height:20%;
            padding: 1%;
            display:table-cell;
        }
        
        .column{
            background-color: darkslategray;
            border-radius: 25px;
            color: white;
            padding:20px;
            margin-top:10px;
            font-size: 20px;

            vertical-align: middle;
            height:75%;
/*            display:table-cell;*/
        }
        
        #StartButton {
            margin-bottom:5%;
        }
        
        #landingPage{
            background: #6EA2A5;
            position:absolute;
            left:0;
            right:0;
            top:0;
            bottom:0;
            height:auto;
            width:auto;
            margin:1%;
            border-radius: 20px;
        }
        
/*        PAGE 1----*/
    
        #page1 {
            width: auto;
            height: 200%;
            background-color:whitesmoke;
            padding:2%;
/*          margin:1%;*/
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top:50px;
        }
        
        div.selection{
            margin-top:0;
            margin-bottom:2px;
            font-size:15pt;
            width:45%;
            margin-left: auto;
            margin-right: auto;
            background-color: whitesmoke;
        }
        
        .selection p{
            margin-top:20px;
            background-color: white;
            border-radius: 20px;
            padding-left: 10px;
        }

        select {
            font-size: 12pt;
        }

        input {
            font-size: 12pt;
            margin:5px;    
        }


        #page1 label {
            font-size: 14pt;
            margin:0;
        }
        #showPage2Button{
            margin-bottom:5%;

        }
/*        ---- Page2*/
        
        #page2 p{
            margin:0;
            text-align: center;
        }

        .node circle {
          fill: #fff;
          stroke: black;
          stroke-width: 2px;
        }

        .node text {
          font: 16px; 
        }

        .link {
          fill: none;
          stroke: lightgray;
          stroke-width: 2px;
        }

        #rightPanel {
            position:absolute;
            display:block;
            width: 300px;
            height: auto;
            top:50px;
            bottom: 0;
            right:0;
            padding: 10px;
            margin: 0.5%;
            background-color: whitesmoke;
        }

        #leftPanel {
           display:block;
            width: 230px;
            height: auto;
            position:absolute;
            top:50px;
            left: 0;
            bottom:0;
            padding: 10px;
            margin: 0.5%;
            background-color: whitesmoke;
            overflow-y: auto; 
        }
        
        .filterClass{
            border-radius: 15px;
            padding: 10px;
            margin:4% 2% 4% 2%;
        }
        
        .filterClass label{
            display: inline-block;
            width:70%;
            padding-left:5px;
            padding-right:5px;
        }
        
        .panelTitle { 
            font-size: 18px;
            text-align: center;
        }
        
        #selectedCoursesPanel{
            height:90%;
            margin-top:10px;
            margin-bottom:30px;
            overflow-y: auto;        
        }

        #selectedCoursesPanel p { 
            font-size: 15px;
            text-align: left;
            margin: 9px;
            padding: 7px 15px 7px 10px;
            border-radius: 10px;
        }

        #middlePanel {
            display:block;
            position:absolute;
            overflow:scroll;
            top:50px;
            bottom:0;
            left:250px;
            right:320px;
/*            width:64%;*/
            height:auto;
            margin-top:0.5%;
            margin-bottom: 0.5%;
/*            margin-right: auto;*/
            background-color:whitesmoke;
        }
        
        .centered{
            margin-top:15px;
            text-align: center;
        }
    #treeSVG{
margin-left:2%

    }
        
        table { 
            width: 100%; 
            border-collapse: collapse;
            font-size: 15px;
        }

        tr{
            background:white;
        }
        
        th { 
            background: #6EA2A5; 
            color: white; 
/*            cursor: s-resize;*/
            font-weight: normal;
            background-repeat: no-repeat;
            background-position: 3% center;
/*            float: left;*/
        }
        
        th p{
            float:right;
            text-align:right;
            margin:0;
            min-width: 17px;
        }
        
        td, th { 
            padding: 5px; 
            border: 2px solid whitesmoke; 
            text-align: left; 
        }
        
        .fakeButton {
          text-decoration: none;
          background-color: #EEEEEE;
          color: #333333;
          padding: 2px 6px 2px 6px;
          border-top: 1px solid #CCCCCC;
          border-right: 1px solid #333333;
          border-bottom: 1px solid #333333;
          border-left: 1px solid #CCCCCC;
            border-radius: 15px;
        }
        
        #detailedViewButton {
            position: absolute;
            /*left: 50%;*/
            bottom: 20px;
            /*right:0;*/
            width:180px;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
        }
        
        #startSelectingButton {
            width: 100px;
            font-size: 20pt;
            position: relative;
            
            left: 10%;
            bottom: 50px;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
        }
        
        button{
            border-radius: 15px;
            padding:10px;
            margin-left:auto;
            margin-right:auto;
            font-size: 14pt;
        }
        
        #page3 {
            position: absolute;
            top:50px;
            bottom:0;
            left:0;
            right:0;
            height:auto;
            width:auto;
            font-size: 11pt;
            background-color:white;
        }
        
        #page3 p{
            text-align: center;
        }
        
        #selectedCoursesTable{
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height:59.5%;
            width:auto;
            overflow-y: auto;
            background-color:whitesmoke;
            margin:0.5%;
        }
        
        #timeTable{
            position: absolute;
            left: 0;
            bottom: 0;
            height:38%;
/*            width:49.3%;*/
            width:50%;
            background-color:whitesmoke;
            margin:0.5%;
        }
        
        #timeTable svg{
            width:80%;
            height: 80%;
        }
        
        #radarChart{
            position: absolute;
            text-align: left;
            right: 0;
            bottom: 0;
            height:38%;
            width:50%;
/*            width:49.3%;*/
            background-color:whitesmoke;
            margin:0.5%;
        }
        
        .caption{
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        

    </style>
</head>
<body>
    <header id='head' style="display:none">E3 Selector</header>
    <div id='landingPage' class='centered'>
        <h1>Welcome to E3 Selector</h1>
        <h2 class='subtitle'>An application intended to help you select E3 courses more easily.</h2>
        <h3 class='subtitle'>The process consists of just three simple steps:</h3>
        <div class='floatingDiv'>
<!--            <div class='floatingDiv'>-->
            <div class='step left'><p class='column'>We'll first ask you for some information enabling us to get rid of all the courses that are not relevant to you. </p></div>
            <div class='step middle'><p class='column'>You can then browse thorough the courses matching your criteria, filter them and select those seeming most interesting to you.</p></div>
            <div class='step right'>
                <p class='column'>
                    Finally, you can inspect your selected courses further and jump to their lsf page to apply for participation.
                </p>
            </div>
<!--            </div>-->
        </div>   
    
    <button class="btn btn-outline-light btn-lg" onclick="showFirstPage()" id="StartButton" >Start</button>
    </div>
        
    <div id="page1" style="display:none">
        <div class = "selection">
            <p>Select your study program:</p>
            <select id=studyProgram>
                <option value="Angewandte Informatik">Angewandte Informatik</option>
                <option value="Bauingenieurwesen">Bauingenieurwesen</option>
                <option value="Elektrotechnik und Informationstechnik">Elektrotechnik und Informationstechnik</option>
                <option value="ISE">ISE</option>
                <option value="Komedia">Komedia</option>
                <option value="Maschinenbau">Maschinenbau</option>
                <option value="MedizinTechnik">Medizintechnik</option>
                <option value="Nano Engineering">Nano Engineering</option>
                <option value="Wirtschaftsingenieurwesen">Wirtschaftsingenieurwesen</option>
            </select>
        </div>
    
        <div class = "selection">
            <p>Which languages would you like your courses to be in?</p>
                <input type="checkbox" name="ok_languages" value="Deutsch" id="de" class = "languageSelection">
                    <label for="de">German</label><br>
                <input type="checkbox" name="ok_languages" value="Englisch" id="en" class = "languageSelection">
                    <label for="en">English</label><br>
                <input type="checkbox" name="ok_languages" value="Türkisch" id="tu" class = "languageSelection">
                    <label for="tu">Turkish</label><br>
                <input type="checkbox" name="ok_languages" value="Niederländisch" id="nl" class = "languageSelection">
                    <label for="nl">Dutch</label><br>
        </div>
    
        <div id="availability"  class="selection">
            <p>When are you free to take courses?</p>
        </div>
        <div class="centered">
        <button type="button" id="showPage2Button" class="centered btn btn-outline-dark">Show Courses</button>
        </div>
    </div>
    
    <div id="page2" style="display:none">
        <div class="row">
            <div id=leftPanel class="col-3">
                <p class="panelTitle caption">
                    Filter Courses
                </p>
                <div class="filterClass" style="background-color:white;">
                    <p class='caption'>Credits</p>
                    <div><div id="slider-range"></div></div>
                </div>
                <div style="background-color:white;" class="filterClass">
                    <p class='caption'>Course Type</p>
                    <input type="checkbox" name="Type" value="VL/Übung" id="lec_ex" class="courseTypeSelection">
                    <label for="lec_ex" style="background-color:lightgreen;">Lecture + Exercise</label><br>
                    <input type="checkbox" name="Type" value="Vorlesung" id="lec" class="courseTypeSelection">
                    <label for="lec" style="background-color:powderblue;">Lecture</label><br>
                    <input type="checkbox" name="Type" value="Seminar" id="sem" class="courseTypeSelection">
                    <label for="sem" style="background-color:peachpuff">Seminar</label><br>
                    <input type="checkbox" name="Type" value="Blockseminar" id="sem_bl" class="courseTypeSelection">
                    <label for="sem_bl" style=background-color:salmon>Blocked Seminar</label><br>
                    <input type="checkbox" name="Type" value="E-Learning" id="e_learn" class="courseTypeSelection">
                    <label for="e_learn" style="background-color:thistle">E-Learning</label><br>
                </div>
                <!--            Make sure to also exclude 'unknown' exam type when filtering-->
                <div style="background-color:white;" class="filterClass">
                    <p class='caption'>Exam Type</p>
                    <input type="checkbox" name="Exam" value="Klausur" id="exam" class="examSelection">
                    <label for="exam">Written Exam</label><br>
                    <input type="checkbox" name="Exam" value="Mündliche Prüfung" id="oral" class="examSelection">
                    <label for="oral">Oral Exam</label><br>
                    <input type="checkbox" name="Exam" value="Schriftliche Ausarbeitung" id="report" class="examSelection">
                    <label for="report">Written Report</label><br>
                    <input type="checkbox" name="Exam" value="Präsentation" id="presentation" class="examSelection">
                    <label for="presentation">Presentation</label><br>
                </div>
                <div style="background-color:white;" class="filterClass">
                    <p class='caption'>Location</p>
                    <input type="checkbox" name="Location" value="Essen" id="essen" class="locationSelection">
                    <label for="essen">Essen</label><br>
                    <input type="checkbox" name="Location" value="Duisburg" id="duisburg" class="locationSelection">
                    <label for="duisburg">Duisburg</label><br>
                    <input type="checkbox" name="Location" value="Bochum" id="bochum" class="locationSelection">
                    <label for="bochum">Bochum</label><br>
                    <input type="checkbox" name="Location" value="Dortmund" id="dortmund" class="locationSelection">
                    <label for="dortmund">Dortmund</label><br>
                </div>
            </div>

            <div id="middlePanel">
                <svg class="col-6" id="treeSVG" preserveAspectRatio="xMinYMin meet" style="margin-left:10px">
                </svg>
            </div>
            <div class="col-3 centered" id=rightPanel>
                <p class="panelTitle caption">
                    Your Selected Courses
                </p>
                <div id=selectedCoursesPanel>
                </div>
                <button type="button" class=" btn btn-outline-dark " id="detailedViewButton">Detailed Overview</button>
            </div>
           
        </div>
        

    </div>
        <div id="page3" style="display:none">
            <div id="selectedCoursesTable">
                <!--                    <p>Narrow down your selection and follow the link to lsf to apply for participation</p>-->
            </div>
            <div style='text-align:right;' id="timeTable">
            </div>
            <div id="radarChart">
            </div>

        </div>

        <script>

            stepIndex = [1, 2, 3];
            d3.select('#landingPage')
                .selectAll('.step')
                .insert("svg", ":first-child")
                .attr('height', '40px')
                .attr('width', '40px')
                .append('g')
                .data(stepIndex)
//                .attr('transform', "translate(-30px, -30px)")
                .append('circle')
                .attr('r', 20)
                .attr('cx', '50%')
                .attr('cy', '50%')
                .attr('fill', 'white');

            d3.select('#landingPage')
                .selectAll('g')
                .append('text')
                .text(function (d) { return d; })
                .attr('x', '37%')
                .attr('y', '65%')
                .attr('style', 'font-color:black;font-size:20pt')

            function showFirstPage() {
                document.getElementById('landingPage').style.display = "none";
                document.getElementById('page1').style.display = "block";
                document.getElementById('head').style.display = "block";

            }

            var seminarColor = "peachpuff";
            var blockSeminarColor = "salmon";
            var lectureColor = "powderblue";
            var lectureExerciseColor = "lightgreen";
            var eLearningColor = "thistle";

            var seminarColorDark = "orange";
            var blockSeminarColorDark = "red";
            var lectureColorDark = "dodgerblue";
            var lectureExerciseColorDark = "limegreen";
            var eLearningColorDark = "darkorchid";

            //PAGE1--------------------------------------------------------------------------------

            var times_userNotAvailable = new Set();
            var colorText = "black";
            var colorAvailable = "green";
            var colorUnavailable = "#D5DBDB";
            var noColor = "none";
            
            var highlightColor = '#FCB8A0';
            var selectedCourseColor = '#E79274';

            document.createSvg = function (tagName) {
                var svgNS = "http://www.w3.org/2000/svg";
                return this.createElementNS(svgNS, tagName);
            };

            var grid = function (numberW, numberPerSide, sizeW, size, pixelsW, pixelsPerSide) {
                var svg = document.createSvg("svg");
                svg.setAttribute("class", "mainElement")
                svg.setAttribute("width", pixelsW);
                svg.setAttribute("height", pixelsPerSide);
                svg.setAttribute("viewBox", [0, 0, numberW * sizeW + numberW, numberPerSide * size + numberPerSide].join(" "));

                var times_display = ["8 - 10", "10 - 12", "12 - 14", "14 - 16", "16 - 18", "18 - 20"];
                var times = ["8-10", "10-12", "12-14", "14-16", "16-18", "18-20"];
                var days_display = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                var days = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];

                for (var i = 0; i < numberW; i++) {
                    for (var j = 0; j < numberPerSide; j++) {

                        var g = document.createSvg("g");
                        g.setAttribute("transform", ["translate(", i * sizeW + i, ",", j * size + j, ")"].join(""));
                        var number = numberPerSide * i + j;
                        var box = document.createSvg("rect");
                        box.setAttribute("width", sizeW);
                        box.setAttribute("height", size);
                        if (i == 0 || j == 0) {
                            box.setAttribute("fill", noColor);
                            if (i == 0 && j > 0) {
                                box.setAttribute("fill", noColor);

                                var text = document.createSvg("text");
                                text.appendChild(document.createTextNode(times_display[j - 1]));
                                text.setAttribute("fill", colorText);
                                text.setAttribute("font-size", 4);
                                text.setAttribute("x", size / 4);
                                text.setAttribute("y", size / 1.7);
                                g.appendChild(text);
                            }
                            if (j == 0 && i > 0) {
                                box.setAttribute("fill", noColor);
                                var text = document.createSvg("text");
                                text.appendChild(document.createTextNode(days_display[i - 1]));
                                text.setAttribute("fill", colorText);
                                text.setAttribute("font-size", 4);
                                text.setAttribute("x", size / 2);
                                text.setAttribute("y", sizeW / 2.5);
                                g.appendChild(text);
                            }
                        }
                        else {
                            box.setAttribute("fill", colorUnavailable);
                            box.setAttribute("id", days[i - 1] + times[j - 1]);
                            times_userNotAvailable.add("" + days[i - 1] + times[j - 1]);
                        }
                        g.appendChild(box);
                        svg.appendChild(g);
                    }
                }
                svg.addEventListener(
                    "click",
                    function (e) {
                        var id = e.target.id;
                        var cell = e.target;
                        if (!id == "") {
                            if (times_userNotAvailable.has(id)) {
                                times_userNotAvailable.delete(id);
                                cell.setAttribute("fill", colorAvailable);
                            }
                            else {
                                times_userNotAvailable.add(id);
                                cell.setAttribute("fill", colorUnavailable);
                            }
                        }
                    },
                    false);
                return svg;
            };

            var container = document.getElementById("availability");
            var timeTableGrid = grid(8, 7, 22, 12, 700, 350);
            container.appendChild(timeTableGrid);

            //PAGE2-------------------------------------------------------------------------------

            // Check all filtering options in the beginning
            d3.select('#page2').selectAll('input').attr('checked', 'true');

            //Data filtered according to study program, availabilities and languages
            var data_filteredAccToPage1;
            //Data used to draw tree
            var treeData;

            d3.json('e3_courses_190120_2.json').then(function (data) {

                //Node indexes
                var i = 0;
                var root;

                // Diagram measurements
                var margin = { top: 20, right: 10, bottom: 10, left: 30},
                    width = 800 - margin.left - margin.right,
                    height = 830 - margin.top - margin.bottom;

                // Layout of tree
                var treemap = d3.tree().size([height, width]);

                var selectedCourses = [];
                var catalogNames = ["BNE", "IOS", "Kultur und Gesellschaft", "Natur und Technik", "Wirtschaft"];

                var showPage2Button = d3.select('#showPage2Button');
                showPage2Button.on('click', filterAccordingToHardConstraints);

                //var svg = d3.select("#treeSVG")
                //    .attr("class", "mainElement")
                //    .attr("width", "100%")
                //    .attr("height", "100%")
                //    .append("g")
                //    .attr("transform", "translate("
                //      + margin.left + "," + margin.top + ")");

                var svg = d3.select("#treeSVG")
                    .attr("class", "mainElement")
                    .attr("viewBox", "-15 0 420 910")
                    .append("g")
                    .attr('transform',"translate(0,20)");

                var selectionPanel = d3.select("#selectedCoursesPanel");

                data_filteredAccToPage1 = data;
                treeData = data_filteredAccToPage1;

                // Assigns parent, children, height, depth
                root = d3.hierarchy(treeData, function (d) { return d.children; });
                root.x0 = height / 2;
                root.y0 = 0;

                // All nodes collapsed
                collapse(root);

                // Collapse node and all children
                function collapse(d) {
                    if (d.children) {
                        d._children = d.children
                        d._children.forEach(collapse)
                        d.children = null
                    }
                }

                update(root, false);

                function filterAccordingToHardConstraints() {

                    //Count how many courses remain after filtering
                    var sumOfCourses = 0;
                    var deleteCourse = false;
                    var subtree;
                    var course;

                    //Copy full data
                    var tempData = JSON.parse(JSON.stringify(data));

                    var studyProgram = d3.select("#studyProgram").node().value;

                    //Select which languages the user does not want
                    var deselectedLanguages = [];
                    var inputElements = document.getElementsByClassName('languageSelection');
                    for (var k = 0; k < inputElements.length; ++k) {
                        if (!inputElements[k].checked) {
                            deselectedLanguages.push(inputElements[k].value);
                        }
                    }

                    //Remove all courses not matching selections; iterate through level 2 nodes
                    for (i = 0; i < tempData.children.length; i++) {

                        subtree = tempData.children[i].children;
                        deleteCourse = false;

                        for (k = subtree.length - 1; k >= 0; k--) {

                            course = subtree[k];
                            deleteCourse = false;

                            for (j = 0; j < deselectedLanguages.length; j++) {
                                if (course.Language.includes(deselectedLanguages[j])) {
                                    deleteCourse = true;
                                }
                                if (course.Ausgeschlossen_Ingenieurwissenschaften_Bachelor.includes(studyProgram)) {
                                    deleteCourse = true;
                                }
                                for (timestamp of times_userNotAvailable) {
                                    //                            alert(course.Times_manual);
                                    //                            alert(timestamp);
                                    if (course.Times_manual.includes(timestamp)) {
                                        deleteCourse = true;
                                    }
                                }

                            }
                            if (deleteCourse) {
                                tempData.children[i].children.splice(tempData.children[i].children.indexOf(course), 1);
                            }
                        }
                        sumOfCourses = sumOfCourses + tempData.children[i].children.length;
                    }

                    if (sumOfCourses > 0) {

                        //              Use filtered data to draw tree
                        data_filteredAccToPage1 = tempData;
                        treeData = data_filteredAccToPage1;

                        //              Reassign tree structure
                        root = d3.hierarchy(treeData, function (d) { return d.children; });
                        root.x0 = height / 2;
                        root.y0 = 0;

                        //              Collapse after the second level
                        root.children.forEach(collapse);

                        //              Expand first catalog
                        root.children[0].children = root.children[0]._children;
                        root.children[0]._children = null;

                        update(root, false);

                        //              Continue to tree view of courses
                        document.getElementById("page1").style.display = "none";
                        document.getElementById("page2").style.display = "block";
                    }
                    else {
                        alert("Your selected options leave no courses to display!");
                    }
                }

                // Add filtering to checkboxes
                d3.select('#page2').selectAll('input').on('click', function(){update(root,true);});

                var credit_range = ["1", "9"];
				
		        function filter_checkboxes(d){
		            var checkboxes = d3.select('#page2').selectAll("input[type='checkbox']:not(:checked)");  
            
		            if(d.data.Title == " " || catalogNames.includes(d.data.Title))
		                {
		                    return true;
		                }
                
		            keepCourse = true;
		            checkboxes.each(
		                function(){
                    
		                    key = this.name;
		                    value = this.value;
                    
		                    //Relaxed condition to also match fields with multiple entries
		                    if(d.data[key].includes(value) || d.data[key] == "unknown"){
		                        keepCourse = false;
		                    }

		                });
                
		                //See if course falls within selected range of credits
		                    minCred = credit_range[0];
		                    maxCred = credit_range[1];
		                    courseCred = d.data["Credits"];
		                    if(courseCred.includes('-')){
		                        courseCredArr = courseCred.split("-");
		                        courseMin = courseCredArr[0];
		                        courseMax = courseCredArr[1];
		                    }
		                    else{
		                        courseMin = courseCred;
		                        courseMax = courseCred;
		                    }
                    
		                    if(courseMax < minCred){
		                        keepCourse = false;
		                    }
		                    if(maxCred < courseMin){
		                        keepCourse = false;
		                    }
                
		                return keepCourse;
		        }

                function update(source, filtering) {

                    var duration;

                    //          When user is just filtering, do not animate tree changes
                    if (filtering) {
                        duration = 0;
                    }
                    else {
                        duration = 750;
                    }

                    // Assigns the x and y position for the nodes
                    var treeData = treemap(root);

                    // Compute new tree layout.
                    var nodes = treeData.descendants();
                    var links = treeData.descendants().slice(1);

                    // Fixed depth
                    nodes.forEach(function (d) { d.y = d.depth * 180 });

                    // ****************** Nodes section ***************************

                    // Update the nodes...
                    // var node = svg.selectAll('g.node')
                    //     .data(nodes, function (d) {
                    //         return d.id || (d.id = ++i);
                    //     });
						
		            var node = svg.selectAll('g.node')
		                .data(nodes.filter(function(d){
		                    return filter_checkboxes(d);
		                }), function(d) {
		                    return d.id || (d.id = ++i); });  

                    // Enter any new nodes at the parent's previous position.
                    var nodeEnter = node.enter().append('g')
                        .attr('class', 'node')
                        .attr("transform", function (d) {
                            return "translate(" + source.y0 + "," + source.x0 + ")";
                        })
                        .on('click', click);

                    // Add Circle for the nodes
                    nodeEnter.append('circle')
                        .attr('class', 'node')
                        .attr('r', 1e-6)
                        .style("fill", function (d) {
                            return d._children ? "lightsteelblue" : "#fff";
                        });

                    // Add labels for the nodes
                    nodeEnter.append('text')
                        .attr('class', 'node')
                        .attr("dy", ".35em")
                        .attr("x", function (d) {
                            //Node labels for empty catalog nodes (2nd level) should appear left
                            if (!d.children && !d._children) {
                                if (catalogNames.includes(d.data.Title)) {
                                    return -13;
                                }
                            }
                            return d.children || d._children ? -13 : 13;
                        })
                        .attr("text-anchor", function (d) {
                            //Node labels for empty catalog nodes should appear left
                            if (!d.children && !d._children) {
                                if (catalogNames.includes(d.data.Title)) {
                                    return "end";
                                }
                            }
                            return d.children || d._children ? "end" : "start";
                        })
                        .text(function (d) { return d.data.Title; });

                    // UPDATE
                    var nodeUpdate = nodeEnter.merge(node);

                    // Transition to the proper position for the node
                    nodeUpdate.transition()
                        .duration(duration)
                        .attr("transform", function (d) {
                            return "translate(" + d.y + "," + d.x + ")";
                        });

                    // Update the node attributes and style
                    nodeUpdate.select('circle.node')
                        .attr('r', 9)
                        .style('fill', function (d) {
                            //Node is not expanded
                        

                            if(d.children){
//                            console.log('CHILDREN '+d.children.length);
                                console.log('TITLE '+Object.getOwnPropertyNames(d.children));
                            }
//                            if(d._children){
//                            console.log('_CHILDREN '+d._children.length);
//                            }
                        
                            if (d._children) {
                                if (d._children.length > 0) {
                                    return "black";
                                }
                            }
                            else {
                                switch (d.data.Type) {
                                    case "Seminar": return seminarColor;
                                    case "Blockseminar": return blockSeminarColor;
                                    case "Vorlesung": return lectureColor;
                                    case "VL/Übung": return lectureExerciseColor;
                                    case "E-Learning": return eLearningColor;
                                    default: return "white";
                                }
                            }
                        })
                        .style('stroke', function (d) {
                            switch (d.data.Type) {
                                case "Seminar": return seminarColorDark;
                                case "Blockseminar": return blockSeminarColorDark;
                                case "Vorlesung": return lectureColorDark;
                                case "VL/Übung": return lectureExerciseColorDark;
                                case "E-Learning": return eLearningColorDark;
                                default: return "black";
                            }
                        })
                        .attr('cursor', 'pointer');

                    //Update node labels
                    nodeUpdate.select('text')
                        .style('fill', function (d) {
                            if (selectedCourses.includes(d.data)) {
                                switch (d.data.Type) {
                                    case "Seminar": return seminarColorDark;
                                    case "Blockseminar": return blockSeminarColorDark;
                                    case "Vorlesung": return lectureColorDark;
                                    case "VL/Übung": return lectureExerciseColorDark;
                                    case "E-Learning": return eLearningColorDark;
                                    default: return "black";
                                }
                            }
                            return "black";
                        })
                        .attr('cursor', 'pointer');

                    // Remove any exiting nodes
                    var nodeExit = node.exit().transition()
                        .duration(duration)
                        .attr("transform", function (d) {
                            return "translate(" + source.y + "," + source.x + ")";
                        })
                        .remove();

                    // On exit reduce the node circles size to 0
                    nodeExit.select('circle')
                        .attr('r', 1e-6);

                    // On exit reduce the opacity of text labels
                    nodeExit.select('text')
                        .style('fill-opacity', 1e-6);

                    // ****************** links section ***************************

                    // Update the links...
                    var link = svg.selectAll('path.link')
                        .data(links.filter(function(d){
		                    return filter_checkboxes(d);
		                }), function (d) { return d.id; });

                    // Enter any new links at the parent's previous position.
                    var linkEnter = link.enter().insert('path', "g")
                        .attr("class", "link")
                        .attr('d', function (d) {
                            var o = { x: source.x0, y: source.y0 }
                            return diagonal(o, o)
                        });

                    // UPDATE
                    var linkUpdate = linkEnter.merge(link);

                    // Transition back to the parent element position
                    linkUpdate.transition()
                        .duration(duration)
                        .attr('d', function (d) { return diagonal(d, d.parent) });

                    // Remove any exiting links
                    var linkExit = link.exit().transition()
                        .duration(duration)
                        .attr('d', function (d) {
                            var o = { x: source.x, y: source.y }
                            return diagonal(o, o)
                        })
                        .remove();

                    // Store the old positions for transition.
                    nodes.forEach(function (d) {
                        d.x0 = d.x;
                        d.y0 = d.y;
                    });

                    // Creates a curved (diagonal) path from parent to the child nodes
                    function diagonal(s, d) {
                        path = `M ${s.y} ${s.x}
                        C ${(s.y + d.y) / 2} ${s.x},
                        ${(s.y + d.y) / 2} ${d.x},
                        ${d.y} ${d.x}`
                        return path
                    }

                    // Toggle children on click.
                    function click(d) {
                        //Treat leaves differently: these are selectable courses
                        if (!d.children && !d._children) {
                            if (catalogNames.includes(d.data.Title)) {
                                //Empty catalog: should be a non-responsive node
                            } else {
                                if (selectedCourses.includes(d.data)) {
                                    var index = selectedCourses.indexOf(d.data);
                                    selectedCourses.splice(index, 1);
                                }
                                else {
                                    selectedCourses.push(d.data);
                                }
                                updateSelectedCourses();
                            }
                        }
                        else {
                            if (d.children) {
                                d._children = d.children;
                                d.children = null;
                            } else {
                                root.children.forEach(collapse);
                                d.children = d._children;
                                d._children = null;
                            }
                            update(d, false);
                        }
                    }

                }

                function updateSelectedCourses() {
                    //Update node labels according to selection
                    d3.select('#treeSVG').selectAll('text')
                        .style('fill', function (d) {
                            if (selectedCourses.includes(d.data)) {
                                switch (d.data.Type) {
                                    case "Seminar": return seminarColorDark;
                                    case "Blockseminar": return blockSeminarColorDark;
                                    case "Vorlesung": return lectureColorDark;
                                    case "VL/Übung": return lectureExerciseColorDark;
                                    case "E-Learning": return eLearningColorDark;
                                    default: return "black";
                                }
                            }
                            return "black";
                        });

                    selectionPanel.selectAll("p").remove();
                    selectionPanel.selectAll('p')
                        .data(selectedCourses).enter()
                        .append('p')
                        .attr('class', 'text')
                        .on('click', function (d) {
                            var index = selectedCourses.indexOf(d);
                            selectedCourses.splice(index, 1);
                            updateSelectedCourses();
                        })
                        .text(function (d) {
                            return d.Title;
                        })
                        .attr('style', function (d) {
                            return "background-color:white;"
                        })
                        .style("position", "relative")
                        .append("svg")
                        .attr("style", "position:absolute;top:-4;right:-10")
                        .attr("height", "24px")
                        .attr("width", "24px")
                        .append("circle")
                        .attr("r", "10px")
                        .attr("cx", "12px")
                        .attr("cy", "12px")
                        .attr("stroke", function (d) {
                            switch (d.Type) {
                                case "Seminar": return seminarColorDark;
                                case "Blockseminar": return blockSeminarColorDark;
                                case "Vorlesung": return lectureColorDark;
                                case "VL/Übung": return lectureExerciseColorDark;
                                case "E-Learning": return eLearningColorDark;
                                default: return "black";
                            }
                        })
                        .attr("stroke-width", "2px")
                        .attr("fill", function (d) {
                            switch (d.Type) {
                                case "Seminar": return seminarColor;
                                case "Blockseminar": return blockSeminarColor;
                                case "Vorlesung": return lectureColor;
                                case "VL/Übung": return lectureExerciseColor;
                                case "E-Learning": return eLearningColor;
                                default: return "black";
                            }
                        });

                    selectionPanel.selectAll("p svg")
                        .append("text")
                        .attr("style", "font-size:17pt;")
                        .attr("x", "52%")
                        .attr("y", "55%")
                        .attr("dominant-baseline", "middle")
                        .attr("text-anchor", "middle")
                        .text("×")
                        .attr('cursor', 'pointer');
                }

                //Slider to filter for credits
                var sliderRange = d3
                    .sliderBottom()
                    .min(1)
                    .max(9)
                    .step(1)
                    .width(150)
                    .ticks(10)
                    .default([1, 9])
                    .fill('darkslategray')
                    .on('onchange', val => {
                        credit_range = val;
                        update(root,true);
                    });

                var gRange = d3
                    .select('div#slider-range')
                    .append('svg')
                    .attr('width', 500)
                    .attr('height', 80)
                    .append('g')
                    .attr('transform', 'translate(12,20)');

                gRange.call(sliderRange);

                d3.select('#detailedViewButton').on('click', showDetailedView);

                function showDetailedView() {
                    if (selectedCourses.length > 0) {
                        fillSelectedCoursesTable();
                        document.getElementById('Recommendation_title').click();
                        timeTableGrid_page3 = timeTableGrid.cloneNode(true);
                        var courseTimes = document.getElementById("timeTable");
                        courseTimes.appendChild(timeTableGrid_page3);
                        document.getElementById("page2").style.display = "none";
                        document.getElementById("page3").style.display = "block";
                    }
                    else {
                        alert('Please select some courses to compare!')
                    }
                }

                //PAGE3--------------------------------------------------------------------------------
                var titles = ["Delete", "Title", "Recommendation", "Credits", "Type", "Exam", "Location", "Language", "Link"];

                //Define basic table structure
                var table = d3.select('#selectedCoursesTable').append('table').attr("id", 'courseTable');
                var sortAscending = true;
                
                var rows = table.append('tbody');
                var headers = table.append('thead').append('tr')
                    .selectAll('th')
                    .data(titles)
                    .enter()
                    .append('th')
                    .attr('id',function(d){return d+'_title';})
                    .text(function (d) {
                        return d;
                    });
                
                headers.append('p')
                    .attr('class','sort-marker');
                
                    headers.on('click', function (d) {
                        if(this.id.localeCompare('Delete_title')==0 || this.id.localeCompare('Link_title')==0){
                            return null;
                        }else{
                        var table_rows = d3.selectAll('tbody').selectAll('.table-data')
                           headers.attr('class', 'header');

                           if (sortAscending) {
                             table_rows.sort(
                                 function(a, b) {
                                     if(a[d].localeCompare('') && !b[d].localeCompare('')){
                                         return -1;
                                     }
                                     if(!a[d].localeCompare('') && b[d].localeCompare('')){
                                         return 1;
                                     }
                                     return d3.ascending(a[d], b[d]);
                                 });
                             sortAscending = false;
                             this.className = 'aes';
                               headers.selectAll('p.sort-marker').text('');
                               d3.select(this).selectAll('.sort-marker')
                                   .text('▲');
                           } else {
                             table_rows.sort(
                                 function(a, b) {
                                    if(a[d].localeCompare('') && !b[d].localeCompare('')){
                                         return 1;
                                     }
                                    if(!a[d].localeCompare('') && b[d].localeCompare('')){
                                         return -1;
                                     }
                                     return d3.descending(a[d], b[d]);
                                 });
                             sortAscending = true;
                             this.className = 'des';
                               headers.selectAll('p.sort-marker').text('');
                               d3.select(this).selectAll('.sort-marker')
                                   .text('▼');
                           }

                    }});
                
                function fillSelectedCoursesTable() {

                    rows.selectAll('.table-data').remove();
                    rows.selectAll('tr')
                        .data(selectedCourses).enter()
                        .append('tr')
                        .attr('class', 'table-data')
                        .selectAll('td')
                        .data(function (d) {
                            return titles.map(function (k) {
                                return { 'value': d[k], 'name': k };
                            });
                        }).enter()
                        .append('td')
                        .attr('data-th', function (d) {
                            return d.name;
                        })
                        .attr('class', function (d) {
                            return d.name;
                        })
                        .text(function (d) {
                            if (!(d.name == "Link") && !(d.name == "Recommendation") && !(d.name == "Delete")) {
                                return d.value;
                            }
                        });

                    rows.selectAll('.Link').append('a')
                        .attr('href', function (d) {
                            return d.value;
                        })
                        .attr('target', '_blank')
                        .attr('class', 'fakeButton')
                        .text("LSF");

                    rows.selectAll('.table-data').selectAll('.Recommendation')
                        .append('svg')
                        .attr('height', '30px')
                        .attr('width', function (d) {
                            if (d.value > 0) {
                                return d.value + "px";
                            } else {
                                return "0px";
                            }
                        })
                        .append('rect')
                        .attr('fill', 'palegreen')
                        .attr('height', '30px')
                        .attr('width', function (d) {
                            if (d.value > 0)
                                return "100%";
                        })
                        .each(function (d) {
                            d3.select(this.parentNode).append('text')
                                .text(function (d) {
                                    if (d.value > 0)
                                        return d.value + "%";
                                })
                                .attr('x', '5%')
                                .attr('y', '70%');
                        });

                    // Make cells deletable
                    d3.selectAll('tr').each(function (d) {
                        d3.select(this).selectAll('.Delete').each(function () {
                            d3.select(this)
                                .append('svg')
                                .attr('height', '30px')
                                .attr('width', '50px')
                                .append('circle')
                                .attr('r', 14)
                                .attr("cx", '50%')
                                .attr('cy', '50%')
                                .attr('fill', 'white')
                                .attr('stroke', 'black')
                                .on('click', function () {
                                    var index = selectedCourses.indexOf(d);
                                    selectedCourses.splice(index, 1);
                                    fillSelectedCoursesTable();
                                })
                                .each(function () {
                                    d3.select(this.parentNode)
                                        .append('text')
                                        .on('click', function () {
                                            var index = selectedCourses.indexOf(d);
                                            selectedCourses.splice(index, 1);
                                            fillSelectedCoursesTable();
                                        })
                                        .attr("style", "font-size:17pt;")
                                        .attr("x", "50%")
                                        .attr("y", "55%")
                                        .attr("dominant-baseline", "middle")
                                        .attr("text-anchor", "middle")
                                        .text('×');
                                })
                        });
                    });

                    var timeTable = d3.select('#timeTable');
                    var times = [];
                    var time;
                    var courseTimes;

                    //Enable selection of courses
                    d3.selectAll('.table-data')
                        .on('click', function (d) {
                            //Check if course is currently selected
                            if (d3.select(this).selectAll('.Title').attr('style') != null && d3.select(this).selectAll('.Title').attr('style').includes('background-color:'+selectedCourseColor)) {
                                d3.select(this).selectAll('.Title')
                                    .attr('style', 'background-color:none');

                                times = [];
                                courseTimes = d.Times_manual;
                                if (!courseTimes == "") {
                                    if (courseTimes.includes(';')) {
                                        times = courseTimes.split(';');
                                    }
                                    else {
                                        times.push(courseTimes);
                                    }
                                    for (t = 0; t < times.length; t++) {
                                        time = times[t];
                                        var name = '#' + time;
                                        timeTable.select(name).each(function () {
                                            d3.select(this.parentNode)
                                                .selectAll('.courseMarker').remove();
                                        })
                                    }
                                }

                            }
                            else {
                                //Reset selection
                                timeTable.select('.courseMarker').remove();
                                d3.select('#courseTable').selectAll('.Title')
                                    .attr('style', 'background-color:none');

                                d3.select(this).selectAll('.Title')
                                    .attr('style', 'background-color:'+selectedCourseColor);

                                times = [];
                                courseTimes = d.Times_manual;

                                if (!courseTimes == "") {
                                    if (courseTimes.includes(';')) {
                                        times = courseTimes.split(';');
                                    }
                                    else {
                                        times.push(courseTimes);
                                    }
                                    for (t = 0; t < times.length; t++) {
                                        time = times[t];
                                        var name = '#' + time;
                                        timeTable.select(name).each(function () {
                                            d3.select(this.parentNode)
                                                .append('g')
                                                .append('circle')
                                                .attr('r', 5)
                                                .attr('cx', '11px')
                                                .attr('cy', '6px')
                                                .attr('class', 'courseMarker')
                                                .attr('fill', selectedCourseColor);
                                        })
                                    }
                                }
                            }
                        });

                    //RadarChart properties
                    var data_r = [
                        {
                            name: 'Average',
                            axes: [
                                { axis: 'fair', value: 4.05 },
                                { axis: 'support', value: 3.91 },
                                { axis: 'material', value: 3.77 },
                                { axis: 'comprehensible', value: 4.02 },
                                { axis: 'fun', value: 3.67 },
                                { axis: 'interesting', value: 3.82 },
                                { axis: 'grade/effort', value: 4.07 }
                            ],
                            color: '#26AF32'
                        }
                    ];

                    var radarMargin = { top: 65, right: 80, bottom: 50, left: 300 },
                        width = Math.min(700, window.innerWidth / 4) - margin.left - margin.right,
                        height = Math.min(width, window.innerHeight - margin.top - margin.bottom);

                    var radarChartOptions = {
                        w: 600,
                        h: 200,
                        margin: radarMargin,
                        levels: 5,
                        maxValue: 5,
                        legend: { title: '', translateX: -50, translateY: 100 },
                        roundStrokes: false,
                        color: d3.scaleOrdinal().range(["darkslategray", "darkslategray", highlightColor, highlightColor]),
                        format: '.0f'
                    };

                    var svg_radar1 = RadarChart("#radarChart", data_r, radarChartOptions);

                    var fair;
                    var support;
                    var material;
                    var comprehensible;
                    var fun;
                    var interesting;
                    var grade_effort;


                    //Visually display couse hours in timetable
                    d3.selectAll('.table-data')
                        .on('mouseenter', function (d) {
                            d3.select(this)
                                .attr('style', 'background-color:'+highlightColor+';');

                            times = [];
                            courseTimes = d.Times_manual;
                            if (!courseTimes == "") {
                                if (courseTimes.includes(';')) {
                                    times = courseTimes.split(';');
                                }
                                else {
                                    times.push(courseTimes);
                                }
                                for (t = 0; t < times.length; t++) {
                                    time = times[t];
                                    var name = '#' + time;
                                    timeTable.select(name)
                                        //                                .transition()
                                        //                                .duration(300)
                                        .attr('fill', highlightColor);
                                }
                            }

                            //Display course ratings in radar chart

                            //if it has ratings: show them, else show that there aren't any

                            fair = d.fairness;
                            support = d.support;
                            material = d.material;
                            comprehensible = d.comprehensibility;
                            fun = d.fun;
                            interesting = d.interesting;
                            grade_effort = d.grade_effort;

                            var hasRatings = false;


                            if ((!fair == '') && (!support == '') && (!material == '') && (!comprehensible == '') && (!fun == '') && (!interesting == '') && (!grade_effort == '')) {

                                hasRatings = true;

                            }

                            if (!hasRatings) {
                                fair = 0;
                                support = 0;
                                material = 0;
                                comprehensible = 0;
                                fun = 0;
                                interesting = 0;
                                grade_effort = 0;
                            }

                            var data_r_withSelectedCourse = [
                                {
                                    name: 'Average',
                                    axes: [
                                        { axis: 'fair', value: 4.05 },
                                        { axis: 'support', value: 3.91 },
                                        { axis: 'material', value: 3.77 },
                                        { axis: 'comprehensible', value: 4.02 },
                                        { axis: 'fun', value: 3.67 },
                                        { axis: 'interesting', value: 3.82 },
                                        { axis: 'grade/effort', value: 4.07 }
                                    ],
                                    color: '#26AF32'
                                },
                                {
                                    name: d.Title,
                                    axes: [
                                        { axis: 'fair', value: fair },
                                        { axis: 'support', value: support },
                                        { axis: 'material', value: material },
                                        { axis: 'comprehensible', value: comprehensible },
                                        { axis: 'fun', value: fun },
                                        { axis: 'interesting', value: interesting },
                                        { axis: 'grade/effort', value: grade_effort }
                                    ],
                                    color: 'blue'
                                }
                            ];

                            svg_radar1 = RadarChart("#radarChart", data_r_withSelectedCourse, radarChartOptions);

                            if (!hasRatings) {
                                //                        alert('no ratings');
                                var noRatings = svg_radar1.append('g');
                                //                            .append('rect')
                                //                            .attr('fill','#A9CCE3')
                                //                            .attr('width','200px')
                                //                            .attr('height','200px');
                                noRatings
                                    .append('circle')
                                    .attr('transform', 'translate(300,165)')
                                    //                            .attr('transform','translate(310,120)')
                                    .attr('fill', highlightColor)
                                    .attr('r', 50);
                                //                            .attr('width','100px')
                                //                            .attr('height','100px');
                                noRatings
                                    .append('text')
                                    .attr('x', '30.5%')
                                    .attr('y', '50%')
                                    .attr("text-anchor", "middle")
                                    .text('NO RATINGS');
                                noRatings
                                    .append('text')
                                    .attr('x', '30.5%')
                                    .attr('y', '55%')
                                    .attr("text-anchor", "middle")
                                    .text('AVAILABLE');
                            }

                        });

                    d3.selectAll('.table-data')
                        .on('mouseleave', function (d) {
                            d3.select(this)
                                .attr('style', 'background-color:white;');

                            times = [];
                            courseTimes = d.Times_manual;
                            if (!courseTimes == "") {
                                if (courseTimes.includes(';')) {
                                    var times = courseTimes.split(';');
                                }
                                else {
                                    times.push(courseTimes);
                                }

                                for (t = 0; t < times.length; t++) {
                                    time = times[t];
                                    var name = '#' + time;
                                    timeTable.select(name)
                                        .attr('fill', function () {
                                            return d3.select('#availability').select('#' + this.id).attr('fill');
                                        });
                                }
                            }

                            //Reset radar chart to only show average ratings
                            d3.select('#radarChart').selectAll('svg').remove();
                            svg_radar1 = RadarChart("#radarChart", data_r, radarChartOptions);

                        });
                }


            });



        </script>
</body>
</html>