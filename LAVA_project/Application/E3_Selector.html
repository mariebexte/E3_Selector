<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <title>E3 Selector: Enter your data</title>

    <!-- CSS Files -->
    <link href="c3.min.css" rel="stylesheet">

    <!-- JS Files -->
    <script type="text/javascript" src="d3.min.js"></script>
    <script type="text/javascript" src="c3.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
        
    <style>
    
        #page1 {
            margin:auto;
            margin-top: 1%;
            margin-bottom: 1%;
            width: 42%;
            height: 98%;
/*            font-size: 12pt;*/
            font-family: "Futura";
            background-color:lightblue;
            padding:2%;
            border-radius: 20px;
        }
        
        #page2 p{
            margin:0;
            font-family: "Futura";
            text-align: center;
        }
        
/*
        #page2 div{
            border-radius: 15px;
            padding: 15px;
            margin:2%;
        }
*/
        
        .selection p{
            padding:0;
            margin:0 0 5px 0;
            font-size:14pt;
        }

/*
        #page1 div {
            margin-bottom: 30px;
        }
*/
        
        #container{
            width: auto;
        }

        button {
            font-size: 14pt;
            font-family: "Futura";
        }

        select {
            font-size: 12pt;
            font-family: "Futura";
        }

        input {
            font-size: 12pt;
            font-family: "Futura";
            margin:5px;
            
        }


        label {
            font-size: 11pt;
            font-family: "Futura";
        }

        .node circle {
          fill: #fff;
          stroke: black;
          stroke-width: 2px;
        }

        .node text {
          font: 12px sans-serif;
          font-family: "Futura";  
        }

        .link {
          fill: none;
          stroke: lightgray;
          stroke-width: 2px;
        }

        #rightPanel {
            position:absolute;
            display:block;
            width: 20.5%;
            height: auto;
            top:0;
            bottom: 0;
           right:0;
            padding: 10px;
            margin: 0.5%;
            background-color: whitesmoke;
        }

        #leftPanel {
           display:block;
            width: 12%;
            height: auto;
            position:absolute;
           top:0;
            left: 0;
           bottom:0;
            padding: 10px;
            margin: 0.5%;
            background-color: whitesmoke;
        }
        
        .filterClass{
            border-radius: 15px;
            padding: 10px;
            margin:4% 2% 4% 2%;
        }
        
        .filterClass label{
            display: inline-block;
            width:70%;
            padding-left:5px;
            padding-right:5px;
        }
        
        .panelTitle {
            font-family: "Futura";  
            font-size: 18px;
            text-align: center;
        }

        #selectedCoursesPanel p { 
            font-family: "Futura";  
            font-size: 12px;
            text-align: left;
            margin: 5px;
            padding: 7px 12px 7px 10px;
            border-radius: 10px;
        }

        #middlePanel {
            display:block;
            position:absolute;
            top:0;
            bottom:0;
            left:15%;
            width:62%;
            height:auto;
            margin-top:0.5%;
            margin-bottom: 0.5%;
            margin-right: auto;
            background-color:whitesmoke;
        }

        #detailedViewButton {
            position: absolute;
            left: 50%;
            bottom: 10px;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
        }
        
        button{
            border-radius: 15px;
            padding:10px;
            margin-left:auto;
            margin-right:auto;
        }
        
        .selection{
            background-color:white;
            border-radius:15px;
            padding:2%;
            width:auto;
            margin-bottom: 3%;
        }
        
        .centered{
            margin:0;
            text-align: center;
        }
        
        .header{
            text-align: center;
            margin-top: 0;
            margin-bottom: 2%;
            font-size: 18pt;
        }
        
        svg.mainElement {
            width: 100%;
            height: 100%;
        }
            
        /* 
        Generic Styling, for Desktops/Laptops 
        */
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        /* Zebra striping */
/*
        tr:nth-of-type(odd) { 
            background: #eee; 
        }
*/
        tr{
            background:white;
        }
        th { 
            background: black; 
            color: white; 
            cursor: s-resize;
            font-weight: normal;
            background-repeat: no-repeat;
            background-position: 3% center;
        }
        td, th { 
            padding: 5px; 
            border: 2px solid whitesmoke; 
            text-align: left; 
        }
        
        .fakeButton {
          text-decoration: none;
          background-color: #EEEEEE;
          color: #333333;
          padding: 2px 6px 2px 6px;
          border-top: 1px solid #CCCCCC;
          border-right: 1px solid #333333;
          border-bottom: 1px solid #333333;
          border-left: 1px solid #CCCCCC;
            border-radius: 15px;
        }
        
        #page3 {
            position: absolute;
            top:0;
            bottom:0;
            left:0;
            right:0;
            height:auto;
            width:auto;
            font-family: "Futura";
            font-size: 11pt;
            background-color:white;
        }
        
        #page3 p{
            text-align: center;
        }
        
        #selectedCoursesTable{
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height:59.5%;
            width:auto;
            background-color:whitesmoke;
            margin:0.5%;
        }
        
        #timeTable{
            position: absolute;
            left: 0;
            bottom: 0;
            height:38%;
            width:40%;
            background-color:whitesmoke;
            margin:0.5%;
        }
        
        #radarChart{
            position: absolute;
            right: 0;
            bottom: 0;
            height:38%;
            width:58.5%;
            background-color:whitesmoke;
            margin:0.5%;
        }

    </style>
</head>
<body>
    
    <div id="page1">
        <p class="header">
            E3 Selector
        </p>
        <div class = "selection">
            <p>Select your study program:</p>
            <select id=studyProgram>
                <option value="Angewandte Informatik">Angewandte Informatik</option>
                <option value="Bauingenieurwesen">Bauingenieurwesen</option>
                <option value="Elektrotechnik und Informationstechnik">Elektrotechnik und Informationstechnik</option>
                <option value="ISE">ISE</option>
                <option value="Komedia">Komedia</option>
                <option value="Maschinenbau">Maschinenbau</option>
                <option value="MedizinTechnik">Medizintechnik</option>
                <option value="Nano Engineering">Nano Engineering</option>
                <option value="Wirtschaftsingenieurwesen">Wirtschaftsingenieurwesen</option>
            </select>
        </div>
    
        <div class = "selection">
            <p>Which languages would you like your courses to be in?</p>
                <input type="checkbox" name="ok_languages" value="Deutsch" id="de" class = "languageSelection">
                    <label for="de">German</label><br>
                <input type="checkbox" name="ok_languages" value="Englisch" id="en" class = "languageSelection">
                    <label for="en">English</label><br>
                <input type="checkbox" name="ok_languages" value="Türkisch" id="tu" class = "languageSelection">
                    <label for="tu">Turkish</label><br>
                <input type="checkbox" name="ok_languages" value="Niederländisch" id="nl" class = "languageSelection">
                    <label for="nl">Dutch</label><br>
        </div>
    
        <div id="availability"  class="selection">
            <p>When are you free to take courses?</p>
        </div>
        <div class="centered">
        <button type="button" id="showPage2Button" class="centered">Show Courses</button>
        </div>
    </div>
    
    <div id="page2" style="display:none">
        <div id=leftPanel>
            <p class="panelTitle">
                Filter Courses
            </p>
            <div class="row align-items-center" style="background-color:white;" class="filterClass">
                <div class="col-sm-2"><p id="value-range"></p></div>
                <div class="col-sm"><div id="slider-range"></div></div>
            </div>
            <div style="background-color:white;" class="filterClass">
                <p>Course Type</p>
                <input type="checkbox" name="Veranstaltungsart" value="VL/Übung" id="lec_ex" class = "courseTypeSelection">
                    <label for="lec_ex" style="background-color:lightgreen;">Lecture + Exercise</label><br>
                <input type="checkbox" name="Veranstaltungsart" value="Vorlesung" id="lec" class = "courseTypeSelection">
                    <label for="lec" style="background-color:powderblue;">Lecture</label><br>
                <input type="checkbox" name="Veranstaltungsart" value="Seminar" id="sem" class = "courseTypeSelection">
                    <label for="sem" style="background-color:peachpuff">Seminar</label><br>
                <input type="checkbox" name="Veranstaltungsart" value="Blockseminar" id="sem_bl" class = "courseTypeSelection">
                    <label for="sem_bl" style=background-color:salmon>Blocked Seminar</label><br>
                <input type="checkbox" name="Veranstaltungsart" value="E-Learning" id="e_learn" class = "courseTypeSelection">
                    <label for="e_learn" style="background-color:thistle">E-Learning</label><br>
            </div>
<!--            Make sure to also exclude 'unknown' exam type when filtering-->
            <div style="background-color:white;" class="filterClass">
                <p>Exam Type</p>
                <input type="checkbox" name="Exam" value="Klausur" id="exam" class = "examSelection">
                    <label for="exam">Written Exam</label><br>
                <input type="checkbox" name="Exam" value="Mündliche Prüfung" id="oral" class = "examSelection">
                    <label for="oral">Oral Exam</label><br>
                <input type="checkbox" name="Exam" value="Schriftliche Ausarbeitung" id="report" class = "examSelection">
                    <label for="report">Written Report</label><br>
                <input type="checkbox" name="Exam" value="Präsentation" id="presentation" class = "examSelection">
                    <label for="presentation">Presentation</label><br>
            </div>
            <div style="background-color:white;" class="filterClass">
                <p>Location</p>
                <input type="checkbox" name="Location" value="Essen" id="essen" class = "locationSelection">
                    <label for="essen">Essen</label><br>
                <input type="checkbox" name="Location" value="Duisburg" id="duisburg" class = "locationSelection">
                    <label for="duisburg">Duisburg</label><br>
                <input type="checkbox" name="Location" value="Bochum" id="bochum" class = "locationSelection">
                    <label for="bochum">Bochum</label><br>
                <input type="checkbox" name="Location" value="Dortmund" id="dortmund" class = "locationSelection">
                    <label for="dortmund">Dortmund</label><br>
            </div>
        </div>
        <div id="middlePanel">
            <svg id="treeSVG" >
            </svg>
        </div>
        <div id=rightPanel>
            <p class="panelTitle">
                Your Selected Courses
            </p>
            <div id=selectedCoursesPanel>
            </div>
            <button type="button" class="panelTitle" id="detailedViewButton">Detailed Overview</button>
        </div> 
    </div>
    
    <div id="page3" style="display:none">
        <p>Narrow down your selection and follow the link to lsf to apply for participation</p>
        <div id="selectedCoursesTable">
        </div>
        <div id="timeTable">
        </div>
        <div id="radarChart">
        </div>
        
    </div>

<script>
    
        var seminarColor="peachpuff";
        var blockSeminarColor="salmon";
        var lectureColor="powderblue";
        var lectureExerciseColor="lightgreen";
        var eLearningColor="thistle";

        var seminarColorDark="orange";
        var blockSeminarColorDark="red";
        var lectureColorDark="dodgerblue";
        var lectureExerciseColorDark="limegreen";
        var eLearningColorDark="darkorchid";
    
    //PAGE1-------------------------------------------------------------------------------- 

    var times_userNotAvailable = new Set();
    var colorText = "black";
    var colorAvailable = "lightgreen";
    var colorUnavailable = "peachpuff"; 
    var noColor = "none";
    
    document.createSvg = function(tagName) {
        var svgNS = "http://www.w3.org/2000/svg";
        return this.createElementNS(svgNS, tagName);
    };

    var grid = function(numberW, numberPerSide, sizeW, size, pixelsW, pixelsPerSide) {
        var svg = document.createSvg("svg");
        svg.setAttribute("class", "mainElement")
        svg.setAttribute("width", pixelsW);
        svg.setAttribute("height", pixelsPerSide);
        svg.setAttribute("viewBox", [0, 0, numberW * sizeW + numberW, numberPerSide * size + numberPerSide].join(" "));

        var times_display = ["8 - 10","10 - 12","12 - 14","14 - 16","16 - 18","18 - 20"];
        var times = ["8-10","10-12","12-14","14-16","16-18","18-20"];
        var days_display = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
        var days = ["Mo","Di","Mi","Do","Fr","Sa","So"];

        for(var i = 0; i < numberW; i++) {
            for(var j = 0; j < numberPerSide; j++) {

              var g = document.createSvg("g");
              g.setAttribute("transform", ["translate(", i*sizeW + i, ",", j*size + j, ")"].join(""));
              var number = numberPerSide * i + j;
              var box = document.createSvg("rect");
              box.setAttribute("width", sizeW);
              box.setAttribute("height", size);
                if(i==0 || j == 0){
                    box.setAttribute("fill", noColor);
                    if(i==0 && j>0){
                        box.setAttribute("fill", noColor);

                        var text = document.createSvg("text");
                        text.appendChild(document.createTextNode(times_display[j-1]));
                        text.setAttribute("fill", colorText);
                        text.setAttribute("font-size", 4);
                        text.setAttribute("x", size/4);
                        text.setAttribute("y", size/1.7);
                        g.appendChild(text);
                    }
                    if(j==0 && i>0){
                        box.setAttribute("fill", noColor);
                        var text = document.createSvg("text");
                        text.appendChild(document.createTextNode(days_display[i-1]));
                        text.setAttribute("fill", colorText);
                        text.setAttribute("font-size", 4);
                        text.setAttribute("x", size/2);
                        text.setAttribute("y", sizeW/2.5);
                        g.appendChild(text);
                    }
                }
                else{
                    box.setAttribute("fill", colorUnavailable);
                    box.setAttribute("id", days[i-1] + times[j-1]);
                    times_userNotAvailable.add(""+days[i-1] + times[j-1]);
                }
              g.appendChild(box);
              svg.appendChild(g);
            }  
        }
        svg.addEventListener(
            "click",
            function(e){
                var id = e.target.id;
                var cell = e.target;
                if(times_userNotAvailable.has(id)){
                    times_userNotAvailable.delete(id);
                    cell.setAttribute("fill",colorAvailable);
                }
                else{
                    times_userNotAvailable.add(id);
                    cell.setAttribute("fill",colorUnavailable);
                }
            },
            false);
        return svg;
    };
    
    var container = document.getElementById("availability");
    var timeTableGrid = grid(8, 7, 22, 12, 700, 350);
    container.appendChild(timeTableGrid);

    //PAGE2-------------------------------------------------------------------------------

    // Check all filtering options in the beginning
    d3.select('#page2').selectAll('input').attr('checked','true');  
    
    //Data filtered according to study program, availabilities and languages
    var data_filteredAccToPage1;
    //Data used to draw tree
    var treeData;
 
    d3.json('e3_courses_190120_2.json').then(function (data) {
        
        //Node indexes
        var i = 0;
        var root;
        
        // Diagram measurements
        var margin = {top: 20, right: 10, bottom: 10, left: 30},
            width = 800 - margin.left - margin.right,
            height = 830 - margin.top - margin.bottom;
        
        // Layout of tree
        var treemap = d3.tree().size([height, width]);
        
        var selectedCourses = [];
        var catalogNames = ["BNE","IOS","Kultur und Gesellschaft","Natur und Technik","Wirtschaft"];
            
        var showPage2Button = d3.select('#showPage2Button');
        showPage2Button.on('click',filterAccordingToHardConstraints);

        var svg = d3.select("#treeSVG")
            .attr("class", "mainElement")
            .attr("width", "100%")
            .attr("height", "100%")
            .append("g") 
            .attr("transform", "translate("
              + margin.left + "," + margin.top + ")");

        var selectionPanel = d3.select("#selectedCoursesPanel");

        data_filteredAccToPage1 = data;
        treeData = data_filteredAccToPage1;

        // Assigns parent, children, height, depth
        root = d3.hierarchy(treeData, function(d) {return d.children; });
        root.x0 = height / 2;
        root.y0 = 0;

        // All nodes collapsed
        collapse(root);

        // Collapse node and all children
         function collapse(d) {
           if(d.children) {
             d._children = d.children
             d._children.forEach(collapse)
             d.children = null
           }
         }
              
        update(root, false);
        
        function filterAccordingToHardConstraints(){
            
            //Count how many courses remain after filtering
            var sumOfCourses = 0;
            var deleteCourse = false;
            var subtree;
            var course;
            
            //Copy full data
            var tempData = JSON.parse(JSON.stringify(data));
            
            var studyProgram = d3.select("#studyProgram").node().value;
            
            //Select which languages the user does not want
            var deselectedLanguages = []; 
            var inputElements = document.getElementsByClassName('languageSelection');
            for(var k=0; k<inputElements.length; ++k){
                if(!inputElements[k].checked){
                    deselectedLanguages.push(inputElements[k].value);
                }
            }

            //Remove all courses not matching selections; iterate through level 2 nodes
            for(i=0; i<tempData.children.length; i++){
                
                subtree = tempData.children[i].children;
                deleteCourse = false;
                
                for(k=subtree.length-1; k>=0; k--){
                    
                    course = subtree[k];
                    deleteCourse = false;
                    
                    for(j=0; j<deselectedLanguages.length; j++){
                        if(course.Sprache.includes(deselectedLanguages[j])){
                            deleteCourse = true;
                        }
                        if(course.Ausgeschlossen_Ingenieurwissenschaften_Bachelor.includes(studyProgram)){
                            deleteCourse = true;
                        }
                        for(timestamp of times_userNotAvailable){
//                            alert(course.Times_manual);
//                            alert(timestamp);
                            if(course.Times_manual.includes(timestamp)){
                                deleteCourse = true;
                            }
                        }
                        
                    }
                    if(deleteCourse){
                        tempData.children[i].children.splice(tempData.children[i].children.indexOf(course),1);
                    }
                }
                sumOfCourses = sumOfCourses + tempData.children[i].children.length;
            }
           
            if(sumOfCourses > 0){
                
//              Use filtered data to draw tree
                data_filteredAccToPage1 = tempData;
                treeData = data_filteredAccToPage1;

//              Reassign tree structure
                root = d3.hierarchy(treeData, function(d) {return d.children; });
                root.x0 = height / 2;
                root.y0 = 0;

//              Collapse after the second level
                root.children.forEach(collapse);
                
//              Expand first catalog
                root.children[0].children = root.children[0]._children;
                root.children[0]._children = null;

                update(root, false);
                
//              Continue to tree view of courses
                document.getElementById("page1").style.display = "none";
                document.getElementById("page2").style.display = "block";
            }
            else{
                alert("Your selected options leave no courses to display!");
            }
        }
        
        // Add filtering to checkboxes
        d3.select('#page2').selectAll('input').on('click',filterCourses_leftPanel);
        
        var credit_range = ["1","9"];
        
        function filterCourses_leftPanel(){
            
            // Copy data
            var tempData = JSON.parse(JSON.stringify(data_filteredAccToPage1)); 
            
            // Grab all unchecked checkboxes > courses matching their values have to be excluded
            var checkboxes = d3.select('#page2').selectAll("input[type='checkbox']:not(:checked)");          
           
            //Remember which 2nd level nodes were collapsed before filtering
            var collapsed = [];
            
            var subtree;
            var course;
            var key;
            var value;
            var minCred;
            var maxCred;
            var courseCred;
            var courseCredArr;
            var courseMin;
            var courseMax;
            
            for(a = 0; a<root.children.length; a++){
                if(root.children[a]._children || (!root.children[a]._children && !root.children[a].children)){
                    collapsed.push(true);
                }
                else{
                    collapsed.push(false);
                }
            }
            
            for(a=0; a<tempData.children.length; a++){
                subtree = tempData.children[a].children;
                deleteCourse = false;
                        
                for(k=subtree.length-1; k>=0; k--){
                    course = subtree[k];
                    deleteCourse = false;
            
                    checkboxes.each(
                        function(){
                    
                            key = this.name;
                            value = this.value;
                    
                            //Relaxed condition to also match fields with multiple entries
                            if(course[key].includes(value) || course[key] == "unknown"){
                                deleteCourse = true;
                            }

                        }
                    );
                    
                    //See if course falls within selected range of credits
                    minCred = credit_range[0];
                    maxCred = credit_range[1];
                    courseCred = course["Credits_manual"];
                    if(courseCred.includes('-')){
                        courseCredArr = courseCred.split("-");
                        courseMin = courseCredArr[0];
                        courseMax = courseCredArr[1];
                    }
                    else{
                        courseMin = courseCred;
                        courseMax = courseCred;
                    }
                    
                    if(courseMax < minCred){
                        deleteCourse = true;
                    }
                    if(maxCred < courseMin){
                        deleteCourse = true;
                    }
                    
                    if(deleteCourse){
                        tempData.children[a].children.splice(tempData.children[a].children.indexOf(course),1);
                    }
                } 
            }
                        
            // Replace tree data with newly filtered data               
            treeData = tempData;

            // Reassign tree structure
            root = d3.hierarchy(treeData, function(d) {return d.children; });
            root.x0 = height / 2;
            root.y0 = 0;

            // Reinstate collapsed nodes
            for(a = 0; a<root.children.length; a++){
                if(collapsed[a]){
                    collapse(root.children[a]);
                }
            }
            
            update(root, true); 
      
        }
        
        function update(source, filtering) {
            
            var duration;
            
//          When user is just filitering, do not animate tree changes
            if(filtering){
                duration = 0;
            }
            else{
                duration = 750;
            }
            
            // Assigns the x and y position for the nodes
            var treeData = treemap(root);

            // Compute new tree layout.
            var nodes = treeData.descendants();
            var links = treeData.descendants().slice(1);

            // Fixed depth
            nodes.forEach(function(d){ d.y = d.depth * 160});

            // ****************** Nodes section ***************************

            // Update the nodes...
            var node = svg.selectAll('g.node')
                .data(nodes, function(d) {
                    return d.id || (d.id = ++i); });  

            // Enter any new nodes at the parent's previous position.
            var nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr("transform", function(d) {
                    return "translate(" + source.y0 + "," + source.x0 + ")";})
                .on('click', click);

            // Add Circle for the nodes
            nodeEnter.append('circle')
                .attr('class', 'node')
                .attr('r', 1e-6)
                .style("fill", function(d) {
                    return d._children ? "lightsteelblue" : "#fff";});

            // Add labels for the nodes     
            nodeEnter.append('text')
                .attr('class','node')
                .attr("dy", ".35em")
                .attr("x", function(d) {
                    //Node labels for empty catalog nodes (2nd level) should appear left
                    if(!d.children && !d._children){
                        if(catalogNames.includes(d.data.title)){
                            return -13;
                        }
                    }
                    return d.children || d._children ? -13 : 13;})
                .attr("text-anchor", function(d) {
                    //Node labels for empty catalog nodes should appear left
                    if(!d.children && !d._children){
                        if(catalogNames.includes(d.data.title)){
                            return "end";
                        }
                    }
                    return d.children || d._children ? "end" : "start";})
                .text(function(d) { return d.data.title; });

            // UPDATE
            var nodeUpdate = nodeEnter.merge(node);

            // Transition to the proper position for the node
            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", function(d) { 
                    return "translate(" + d.y + "," + d.x + ")";});

            // Update the node attributes and style
            nodeUpdate.select('circle.node')
                .attr('r', 9)
                .style('fill', function(d) {
                    //Node is expanded
                    if(d._children){
                        if(d._children.length > 0){
                            return "black";
                        }
                    }
                    else{
                        switch(d.data.Veranstaltungsart){
                            case "Seminar":return seminarColor;
                            case "Blockseminar": return blockSeminarColor;
                            case "Vorlesung": return lectureColor;
                            case "VL/Übung":return lectureExerciseColor;
                            case "E-Learning":return eLearningColor;    
                            default: return "white";
                        }
                    }
                })
                .style('stroke', function(d) {
                        switch(d.data.Veranstaltungsart){
                            case "Seminar":return seminarColorDark;
                            case "Blockseminar": return blockSeminarColorDark;
                            case "Vorlesung": return lectureColorDark;
                            case "VL/Übung":return lectureExerciseColorDark;
                            case "E-Learning":return eLearningColorDark;    
                            default: return "black";
                        }
                })
                .attr('cursor', 'pointer');

            //Update node labels
            nodeUpdate.select('text')
                .style('fill', function(d) {
                    if(selectedCourses.includes(d.data)){
                        switch(d.data.Veranstaltungsart){
                            case "Seminar":return seminarColorDark;
                            case "Blockseminar": return blockSeminarColorDark;
                            case "Vorlesung": return lectureColorDark;
                            case "VL/Übung":return lectureExerciseColorDark;
                            case "E-Learning":return eLearningColorDark;  
                            default: return "black";
                        }
                    }
                    return "black";
                });

            // Remove any exiting nodes
            var nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", function(d) {
                    return "translate(" + source.y + "," + source.x + ")";})
                .remove();

            // On exit reduce the node circles size to 0
            nodeExit.select('circle')
                .attr('r', 1e-6);

            // On exit reduce the opacity of text labels
            nodeExit.select('text')
                .style('fill-opacity', 1e-6);

            // ****************** links section ***************************

            // Update the links...
            var link = svg.selectAll('path.link')
                .data(links, function(d) { return d.id; });

            // Enter any new links at the parent's previous position.
            var linkEnter = link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', function(d){
                    var o = {x: source.x0, y: source.y0}
                    return diagonal(o, o)});

            // UPDATE
            var linkUpdate = linkEnter.merge(link);

            // Transition back to the parent element position
            linkUpdate.transition()
                .duration(duration)
                .attr('d', function(d){ return diagonal(d, d.parent) });

            // Remove any exiting links
            var linkExit = link.exit().transition()
                .duration(duration)
                .attr('d', function(d) {
                    var o = {x: source.x, y: source.y}
                    return diagonal(o, o)})
                .remove();

            // Store the old positions for transition.
            nodes.forEach(function(d){
                d.x0 = d.x;
                d.y0 = d.y;
            });

            // Creates a curved (diagonal) path from parent to the child nodes
            function diagonal(s, d) {
                path = `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                    ${(s.y + d.y) / 2} ${d.x},
                    ${d.y} ${d.x}`
                return path
            }

            // Toggle children on click.
            function click(d) {
                //Treat leaves differently: these are selectable courses
                if(!d.children && !d._children){
                    if(catalogNames.includes(d.data.title)){
                        //Empty catalog: should be a non-responsive node
                    }else{
                        if(selectedCourses.includes(d.data)){
                            var index = selectedCourses.indexOf(d.data);
                            selectedCourses.splice(index,1);
                        }
                        else{
                            selectedCourses.push(d.data);
                        } 
                        updateSelectedCourses();
                    }
                } 
                else{
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        root.children.forEach(collapse);
                        d.children = d._children;
                        d._children = null;
                    }
                    update(d,false);
                }
            } 
            
        }
        
        function updateSelectedCourses(){
            //Update node labels according to selection        
            d3.select('#treeSVG').selectAll('text')
                .style('fill', function(d) {
                    if(selectedCourses.includes(d.data)){
                        switch(d.data.Veranstaltungsart){
                            case "Seminar":return seminarColorDark;
                            case "Blockseminar": return blockSeminarColorDark;
                            case "Vorlesung": return lectureColorDark;
                            case "VL/Übung":return lectureExerciseColorDark;
                            case "E-Learning":return eLearningColorDark;  
                            default: return "black";
                        }
                    }
                    return "black";
                });
            
            selectionPanel.selectAll("p").remove();  
            selectionPanel.selectAll('p')
                .data(selectedCourses).enter()
                .append('p')
                .attr('class','text')
                .on('click',function(d){
                    var index = selectedCourses.indexOf(d);
                    selectedCourses.splice(index,1);
                    updateSelectedCourses();})
                .text(function(d){
                    return d.title;})
                .attr('style',function(d){
                        return "background-color:white;"})
                    .style("position","relative")
                    .append("svg")
                    .attr("style","position:absolute;top:-4;right:-10")
                    .attr("height","24px")
                    .attr("width","24px")
                    .append("circle")
                    .attr("r","10px")
                    .attr("cx","12px")
                    .attr("cy","12px")
                    .attr("stroke",function(d) {
                        switch(d.Veranstaltungsart){
                            case "Seminar":return seminarColorDark;
                            case "Blockseminar": return blockSeminarColorDark;
                            case "Vorlesung": return lectureColorDark;
                            case "VL/Übung":return lectureExerciseColorDark;
                            case "E-Learning":return eLearningColorDark;    
                            default: return "black";
                        }
                    })
                    .attr("stroke-width","2px")
                    .attr("fill",function(d) {
                        switch(d.Veranstaltungsart){
                            case "Seminar":return seminarColor;
                            case "Blockseminar": return blockSeminarColor;
                            case "Vorlesung": return lectureColor;
                            case "VL/Übung":return lectureExerciseColor;
                            case "E-Learning":return eLearningColor;    
                            default: return "black";
                        }
                    });
            
                selectionPanel.selectAll("p svg")
                .append("text")
                .attr("style","font-size:19px;")
                .attr("x","50%")
                .attr("y","60%")
                .attr("dominant-baseline","middle")
                .attr("text-anchor","middle")
                .text("×");      
        }
        
        d3.select('#detailedViewButton').on('click',showDetailedView);
        
        function showDetailedView(){
            fillSelectedCoursesTable();
            timeTableGrid_page3 = timeTableGrid.cloneNode(true);
            var courseTimes = document.getElementById("timeTable");
            courseTimes.appendChild(timeTableGrid_page3);
            document.getElementById("page2").style.display = "none";
            document.getElementById("page3").style.display = "block";
        } 
        
        //Slider to filter for credits
          var sliderRange = d3
            .sliderBottom()
            .min(1)
            .max(9)
            .step(1)
            .width(150)
            .ticks(10)
            .default([1, 9])
            .fill('darkslategray')
            .on('onchange', val => {
                d3.select('p#value-range').text(val.map(d3.format('.2%')).join('-'));
                credit_range = val;
                filterCourses_leftPanel();
            });

          var gRange = d3
            .select('div#slider-range')
            .append('svg')
            .attr('width', 500)
            .attr('height', 80)
            .append('g')
            .attr('transform', 'translate(30,30)');

          gRange.call(sliderRange);

          d3.select('p#value-range').text(
            sliderRange
              .value()
              .map(d3.format('.2%'))
              .join('-')
          );
    
        //PAGE3--------------------------------------------------------------------------------      
        var titles = ["Delete","title","Recommendation","Credits_manual","Veranstaltungsart","Exam","Location","Sprache","link"];
        
        //Define basic table structure
        var table = d3.select('#selectedCoursesTable').append('table').attr("id",'courseTable');
        table.append('thead').append('tr')
            .selectAll('th')
            .data(titles)
            .enter()
            .append('th')
            .text(function (d) {
                return d;
            });
        var rows = table.append('tbody'); 
        
        function fillSelectedCoursesTable(){
            
            rows.selectAll('.table-data').remove();
            rows.selectAll('tr')
                .data(selectedCourses).enter()
                .append('tr')
                .attr('class','table-data')
                .selectAll('td')
                .data(function (d) {
                    return titles.map(function (k) {
                        return { 'value': d[k], 'name': k};
                    });
                }).enter()
                .append('td')
                .attr('data-th', function (d) {
                    return d.name;
                })
                .attr('class',function(d){
                    return d.name;
                })
                .text(function (d) {
                    if(!(d.name == "link") && !(d.name == "Recommendation") && !(d.name == "Delete")){
                        return d.value;
                    }
                });
  
            rows.selectAll('.link').append('a')
                .attr('href',function(d){
                        return d.value;
                })
                .attr('target','_blank')
                .attr('class','fakeButton')
                .text("LSF");
   
            rows.selectAll('.table-data').selectAll('.Recommendation')
                .append('svg')
                .attr('height','30px')
                .attr('width',function(d){
                      if(d.value > 0)
                        return d.value+"%";
                      })
                .append('rect')
                .attr('fill','palegreen')
                .attr('height','30px')
                .attr('width',function(d){
                      if(d.value > 0)
                        return "100%";
                      })
                .each(function(d){
                    d3.select(this.parentNode).append('text')
                    .text(function(d){
                        if(d.value > 0)
                            return d.value+"%";
                        })
                    .attr('x','5%')
                    .attr('y','70%');
                });
            
            // Make cells deletable
            d3.selectAll('tr').each(function(d) {
                d3.select(this).selectAll('.Delete').each(function() {
                    d3.select(this)
                        .append('svg')
                        .attr('height','30px')
                        .attr('width','50px')
                        .append('circle')
                        .attr('r',14)
                        .attr("cx",'50%')
                        .attr('cy','50%')
                        .attr('fill','white')
                        .attr('stroke','black')
                        .on('click',function(){
                            var index = selectedCourses.indexOf(d);
                            selectedCourses.splice(index,1);
                            fillSelectedCoursesTable();
                        })
                        .each(function(){
                            d3.select(this.parentNode)
                                .append('text')
                                .on('click',function(){
                                    alert(selectedCourses.length);
                                    var index = selectedCourses.indexOf(d);
                                    selectedCourses.splice(index,1);
                                    fillSelectedCoursesTable();
                                    alert(selectedCourses.length);
                                })
                                .attr("style","font-size:19px;")
                                .attr("x","50%")
                                .attr("y","60%")
                                .attr("dominant-baseline","middle")
                                .attr("text-anchor","middle")
                                .text('×');
                        })
                });
            });                
        }
        
    });
    
   

</script>
</body>