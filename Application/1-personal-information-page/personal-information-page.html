<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>E3 Selector</title>
    <link rel="shortcut icon" href="../E3_icon.ico"/>

    <!-- CSS Files -->
    <link href='https://fonts.googleapis.com/css?family=Arsenal' rel='stylesheet'>
    <link rel="stylesheet" href="../scripts/bootstrap.min.css">
    <link rel="stylesheet" href="personal-information-page.css">

    <!-- JS Files -->
    <script type="text/javascript" src="../scripts/d3.min.js"></script> 
    <script type="text/javascript" src="../scripts/dataStorage.js"></script>

</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="../0-landing-page/landing-page.html">
            <img src="../Logo.png" width="90" height="22" class="d-inline-block align-top" alt="">
        </a>
            <div class="navbar-nav">
                <a class="nav-item nav-link active" href="personal-information-page.html">Your Information</a>
                <a class="nav-item nav-link" href="../2-course-tree-page/course-tree-page.html">Course Tree</a>
                <a class="nav-item nav-link" href="../3-selection-page/selection-page.html">Course Selection</a>
            </div>
    </nav>
    
    <div id="form">
        <div class = "selection">
            <p>Select your study program:</p>
            <select id=studyProgram>
                <option value="Angewandte Informatik">Angewandte Informatik</option>
                <option value="Bauingenieurwesen">Bauingenieurwesen</option>
                <option value="Elektrotechnik und Informationstechnik">Elektrotechnik und Informationstechnik</option>
                <option value="ISE">ISE</option>
                <option value="Komedia">Komedia</option>
                <option value="Maschinenbau">Maschinenbau</option>
                <option value="MedizinTechnik">Medizintechnik</option>
                <option value="Nano Engineering">Nano Engineering</option>
                <option value="Wirtschaftsingenieurwesen">Wirtschaftsingenieurwesen</option>
            </select>
        </div>
    
        <div class = "selection">
            <p>Which languages would you like your courses to be in?</p>
                <input type="checkbox" name="ok_languages" value="Deutsch" id="de" class = "languageSelection">
                    <label for="de">German</label><br>
                <input type="checkbox" name="ok_languages" value="Englisch" id="en" class = "languageSelection">
                    <label for="en">English</label><br>
                <input type="checkbox" name="ok_languages" value="Türkisch" id="tu" class = "languageSelection">
                    <label for="tu">Turkish</label><br>
                <input type="checkbox" name="ok_languages" value="Niederländisch" id="nl" class = "languageSelection">
                    <label for="nl">Dutch</label><br>
        </div>
    
        <div id="availability"  class="selection">
            <p>When are you free to take courses?</p>
        </div>
        <div class="centered">
        <button type="button" id="showNextPage" class="btn btn-outline-dark">Show Courses</button>
        </div>
    </div>

    <script>
        //Grid: sizes
        var numberW = 8;
        var numberPerSide = 7;
        var sizeW = 22;
        var size = 12;
        var pixelsW =700;
        var pixelsPerSide = 350;
          
        //Grid: colors
        var colorText = "black";
        var colorAvailable = "green";
        var colorUnavailable = "#D5DBDB";
        var noColor = "none";
         
        //Grid: axes
        var times_userNotAvailable = new Set();
        var times_display = ["8 - 10", "10 - 12", "12 - 14", "14 - 16", "16 - 18", "18 - 20"];
        var times = ["8-10", "10-12", "12-14", "14-16", "16-18", "18-20"];
        var days_display = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        var days = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
            
        var svg = d3.select("#availability").append("svg")
            .attr("width", pixelsW)
            .attr("height", pixelsPerSide)
            .attr("viewBox", [0, 0, numberW * sizeW + numberW, numberPerSide * size + numberPerSide].join(" "));

        //Draw grid
        for (var i = 0; i < numberW; i++) {
            for (var j = 0; j < numberPerSide; j++) {

                var g = svg.append("g").attr("transform", ["translate(", i * sizeW + i, ",", j * size + j, ")"].join(""));
                var number = numberPerSide * i + j;
                var box = g.append("rect")
                    .attr("width", sizeW)
                    .attr("height", size);

                if (i == 0 || j == 0) {
                    box.attr("fill", noColor);

                    //Time nodes
                    if (i == 0 && j > 0) {
                        box.attr("fill", noColor);

                        var text = g.append("text")
                            .text(times_display[j - 1])
                            .attr("fill", colorText)
                            .attr("font-size", 4)
                            .attr("x", size/ 1.5)
                            .attr("y", size / 1.7);

                    }

                    //Day nodes
                    if (j == 0 && i > 0) {
                        box.attr("fill", noColor);
                        var text = g.append("text")
                            .text(days_display[i - 1])
                            .attr("fill", colorText)
                            .attr("font-size", 4)
                            .attr("x", size / 1.5)
                            .attr("y", sizeW / 2.5);
                    }
                }
                //Clickable timetable cells
                else {
                    times_userNotAvailable.add("" + days[i - 1] + times[j - 1]);
                    box.attr("fill", colorUnavailable)
                        .attr("id", days[i - 1] + times[j - 1])
                        .on("click",function(d){
                            if(times_userNotAvailable.has(this.id)){
                                d3.select(this).attr("fill",colorAvailable);
                                times_userNotAvailable.delete(this.id);
                            }
                            else{
                                d3.select(this).attr("fill",colorUnavailable);
                                times_userNotAvailable.add(this.id);
                            }
                        });
                }
            }
        }
        
        //Moving to next page
        var showPage2Button = d3.select('#showNextPage');
        showPage2Button.on('click', filterAccordingToHardConstraints);

        //Apply selection of the user to the full set of courses
        function filterAccordingToHardConstraints() {

            d3.json('../e3_courses.json').then(function (data) {

                //Count how many courses remain after filtering
                var sumOfCourses = 0;
                var deleteCourse;
                var subtree;
                var course;

                //Get user selections
                var studyProgram = d3.select("#studyProgram").node().value;
                var deselectedLanguages = [];
                var inputElements = document.getElementsByClassName('languageSelection');
                for (var k = 0; k < inputElements.length; ++k) {
                    if (!inputElements[k].checked) {
                        deselectedLanguages.push(inputElements[k].value);
                    }
                }
                
                //Remove all courses not matching selections; iterate through level 2 nodes
                for (i = 0; i < data.children.length; i++) {

                    subtree = data.children[i].children;
                    deleteCourse = false;

                    for (k = subtree.length - 1; k >= 0; k--) {

                        course = subtree[k];
                        deleteCourse = false;

                        for (j = 0; j < deselectedLanguages.length; j++) {
                            if (course.Language.includes(deselectedLanguages[j])) {
                                deleteCourse = true;
                            }
                            if (course.Ausgeschlossen_Ingenieurwissenschaften_Bachelor.includes(studyProgram)) {
                                deleteCourse = true;
                            }
                            for (timestamp of times_userNotAvailable) {
                                if (course.Times_manual.includes(timestamp)) {
                                    deleteCourse = true;
                                }
                            }
                        }
                        if (deleteCourse) {
                            data.children[i].children.splice(data.children[i].children.indexOf(course), 1);
                        }
                    }
                    sumOfCourses = sumOfCourses + data.children[i].children.length;
                }

                if (sumOfCourses > 0) {
                    //Save deseletcted timeslots for reuse on final page
                    setDeselectedTimeslots(times_userNotAvailable);

                    //Save filtered data to draw tree on next page
                    setFilteredCourses(data);

                    window.location.href='../2-course-tree-page/course-tree-page.html'
                }
                //Do not proceed if all courses are filtered out
                else {
                    alert("Your selected options leave no courses to display!");
                }
            });
        }

    </script>
</body>
</html>